<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ title or "Stores Demo" }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style> body { padding-top: 24px; } </style>
</head>
<body>
<div class="container">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mt-2">
        {% for category, msg in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}
  {% block content %}{% endblock %}
</div>

<!-- One-time Low Stock Modal -->
<div class="modal fade" id="lowStockModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Low Stock Alert</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>The following items just fell below ROP. Consider ordering now:</p>
        <table class="table table-sm">
          <thead><tr><th>Code</th><th>Name</th><th>Inv Pos</th><th>ROP</th><th>Suggest</th></tr></thead>
          <tbody id="lowStockBody"></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  fetch("{{ url_for('main.low_stock_once') }}", { method: "POST" })
    .then(r => r.json())
    .then(data => {
      if (Array.isArray(data) && data.length > 0) {
        const tbody = document.getElementById("lowStockBody");
        tbody.innerHTML = data.map(d => `
          <tr>
            <td><b>${d.product_code}</b></td>
            <td>${d.name}</td>
            <td>${d.inventory_position}</td>
            <td>${d.ROP}</td>
            <td><b>${d.suggested_order_qty}</b></td>
          </tr>`).join("");
        new bootstrap.Modal(document.getElementById("lowStockModal")).show();
      }
    })
    .catch(console.error);
});
</script>
</body>
</html>
